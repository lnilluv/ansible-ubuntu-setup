- name: Reset ufw to a known state
  ansible.builtin.command: ufw --force reset
  changed_when: false

- name: Set default deny incoming
  ansible.builtin.command: ufw default deny incoming
  changed_when: false

- name: Set default allow outgoing
  ansible.builtin.command: ufw default allow outgoing
  changed_when: false

- name: Allow SSH during bootstrap from operator public IP
  ansible.builtin.command: "ufw allow from {{ bootstrap_allowed_ip }} to any port {{ ssh_port }} proto tcp"
  changed_when: false
  when: hardening_phase == "bootstrap"

- name: Allow SSH on tailscale interface only
  ansible.builtin.command: "ufw allow in on tailscale0 from {{ tailscale_ssh_cidr }} to any port {{ ssh_port }} proto tcp"
  changed_when: false

- name: Remove bootstrap SSH rule after lockdown
  ansible.builtin.command: "ufw delete allow from {{ bootstrap_allowed_ip }} to any port {{ ssh_port }} proto tcp"
  changed_when: false
  when: hardening_phase == "lockdown"

- name: Allow outgoing TCP ports
  ansible.builtin.command: "ufw allow out {{ item }}/tcp"
  changed_when: false
  loop: "{{ outbound_allowed_tcp_ports }}"

- name: Allow outgoing UDP ports
  ansible.builtin.command: "ufw allow out {{ item }}/udp"
  changed_when: false
  loop: "{{ outbound_allowed_udp_ports }}"

- name: Enable UFW
  ansible.builtin.command: ufw --force enable
  changed_when: false
