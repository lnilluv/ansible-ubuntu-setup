- name: Backward-compatible bootstrap alias
  hosts: ubuntu_servers
  gather_facts: false
  become: true
  vars_files:
    - group_vars/all.yml
  vars:
    hardening_phase: bootstrap
    ansible_user: "{{ bootstrap_user | default('root') }}"
    ansible_ssh_timeout: "{{ bootstrap_command_timeout_seconds }}"
    ansible_command_timeout: "{{ bootstrap_command_timeout_seconds }}"
    ansible_ssh_private_key_file: "{{ bootstrap_ssh_private_key_path if bootstrap_auth_method in ['auto', 'key'] and (bootstrap_ssh_private_key_path | length > 0) else '' }}"
    ansible_password: "{{ bootstrap_root_password if bootstrap_auth_method in ['auto', 'password'] and (bootstrap_root_password | length > 0) else '' }}"
    ansible_become_password: "{{ bootstrap_root_password if bootstrap_auth_method in ['auto', 'password'] and (bootstrap_root_password | length > 0) else '' }}"
  pre_tasks:
    - name: Ensure bootstrap auth variables are valid
      ansible.builtin.assert:
        that:
          - bootstrap_auth_method in ['auto', 'key', 'password']
          - (bootstrap_auth_method != 'key') or (bootstrap_ssh_private_key_path | length > 0)
          - (bootstrap_auth_method != 'password') or (bootstrap_root_password | length > 0)
          - (bootstrap_auth_method != 'auto') or ((bootstrap_ssh_private_key_path | length > 0) or (bootstrap_root_password | length > 0))
        fail_msg: "Set bootstrap auth inputs for key/password mode before running requirements-playbook."

    - name: Gather facts preflight
      ansible.builtin.setup:
      become: false
      register: requirements_setup_preflight
      failed_when: false
      ignore_unreachable: true

    - name: Fail with actionable message when setup preflight cannot run
      ansible.builtin.fail:
        msg: >-
          Requirements preflight could not run remote setup.
          If this is a fresh provider image, a forced password rotation may be active.
          Error: {{ requirements_setup_preflight.msg | default(requirements_setup_preflight.stderr, true) }}
          Resolve by logging in once interactively and changing password, then rerun requirements-playbook.
      when:
        - requirements_setup_preflight.unreachable | default(false) or requirements_setup_preflight.failed | default(false)
        - (requirements_setup_preflight.msg | default('')) is search('Failed to create temporary directory')

    - name: Assert setup preflight succeeded
      ansible.builtin.assert:
        that:
          - not (requirements_setup_preflight.unreachable | default(false))
          - not (requirements_setup_preflight.failed | default(false))
        fail_msg: >-
          Requirements connectivity/authentication preflight failed.
          Error: {{ requirements_setup_preflight.msg | default(requirements_setup_preflight.stderr, true) }}
  roles:
    - role: base_ubuntu_2204
    - role: admin_user
